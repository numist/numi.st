---
layout: post
title: Graphviz support for Jekyll
date: 2023-03-17 14:54:30 -0700
---

I'm planning on writing about diffing soon, a problem space that is well-visualized by graphs. So this site needs to support graphs.

I hear a lot of nice things about Mermaid (which has Jekyll support via [`jekyll-mermaid`](https://rubygems.org/gems/jekyll-mermaid/versions/1.0.0)), but I've been using Graphviz for the past two decades and I'm not about to leave an old friend for dead.

Not able to find an existing plugin (and not ready to publish my own gem[^gem]), I've hacked together a custom Liquid block to support rendering a graph from [DOT source](https://graphviz.org/doc/info/lang.html) and I'm sharing it here in case you'd like to do the same.

## Code

1. Add `gem "ruby-graphviz"` to your `Gemfile`
2. Create a new file `_plugins/graphviz.md`:

``` ruby
require 'digest/md5'
require 'ruby-graphviz'

module Jekyll
  class GraphvizBlock < Liquid::Block
    def initialize(tag_name, markup, options)
      super
      @tag = markup
    end

    def render(context)
      graph = GraphViz.parse_string(super)
      raise "\"error in graph #{super.lines.first.chomp}\"" unless graph

      graph_id = @tag unless @tag.empty?
      graph_id ||= graph.id if graph.id.match?(/^[a-zA-Z0-9]+$/)
      graph_id ||= Digest::MD5.hexdigest(super)
      
<<-EOS
<div class=\"graphviz\" id=\"#{ graph_id }\">
<!-- #{super} -->
#{graph.output(:svg => String).sub(/^.*<svg/m, "<svg")}
</div>
EOS
    end
  end
end

Liquid::Template.register_tag('graphviz', Jekyll::GraphvizBlock)
```

## Demo

Assuming your host has the `dot` command line tool installed[^package] (which Netlify does!), the following markup:

{% raw %}
<div class="highlight"><pre class="highlight"><code><span class="p">{%</span><span class="w"> </span><span class="nt">graphviz</span><span class="w"> </span><span class="p">%}</span>
<span class="k">digraph</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">rank</span><span class="p">=</span><span class="nv">same</span><span class="p">;</span> <span class="nv">b</span><span class="p">,</span> <span class="nv">c</span> <span class="p">}</span>
    <span class="nv">a</span> <span class="o">-&gt;</span> <span class="nv">b</span><span class="o">[</span><span class="n">label</span><span class="p">=</span><span class="s2">"0.2"</span><span class="p">,</span><span class="n">weight</span><span class="p">=</span><span class="s2">"0.2"</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">a</span> <span class="o">-&gt;</span> <span class="nv">c</span><span class="o">[</span><span class="n">label</span><span class="p">=</span><span class="s2">"0.4"</span><span class="p">,</span><span class="n">weight</span><span class="p">=</span><span class="s2">"0.4"</span><span class="p">,</span><span class="n">color</span><span class="p">=</span><span class="nv">red</span><span class="p">,</span><span class="n">penwidth</span><span class="p">=</span><span class="mf">3.0</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">c</span> <span class="o">-&gt;</span> <span class="nv">b</span><span class="o">[</span><span class="n">label</span><span class="p">=</span><span class="s2">"0.6"</span><span class="p">,</span><span class="n">weight</span><span class="p">=</span><span class="s2">"0.6"</span><span class="p">,</span><span class="n">constraint</span><span class="p">=</span><span class="nv">false</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">c</span> <span class="o">-&gt;</span> <span class="nv">e</span><span class="o">[</span><span class="n">label</span><span class="p">=</span><span class="s2">"0.6"</span><span class="p">,</span><span class="n">weight</span><span class="p">=</span><span class="s2">"0.6"</span><span class="p">,</span><span class="n">color</span><span class="p">=</span><span class="nv">red</span><span class="p">,</span><span class="n">penwidth</span><span class="p">=</span><span class="mf">3.0</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">e</span> <span class="o">-&gt;</span> <span class="nv">e</span><span class="o">[</span><span class="n">label</span><span class="p">=</span><span class="s2">"0.1"</span><span class="p">,</span><span class="n">weight</span><span class="p">=</span><span class="s2">"0.1"</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">e</span> <span class="o">-&gt;</span> <span class="nv">b</span><span class="o">[</span><span class="n">label</span><span class="p">=</span><span class="s2">"0.7"</span><span class="p">,</span><span class="n">weight</span><span class="p">=</span><span class="s2">"0.7"</span><span class="p">,</span><span class="n">color</span><span class="p">=</span><span class="nv">red</span><span class="p">,</span><span class="n">penwidth</span><span class="p">=</span><span class="mf">3.0</span><span class="p">,</span><span class="n">constraint</span><span class="p">=</span><span class="nv">false</span><span class="o">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">{%</span><span class="w"> </span><span class="nt">endgraphviz</span><span class="w"> </span><span class="p">%}</span>
</code></pre></div>
{% endraw %}

Will render to:

``` html
{% graphviz %}
digraph {
    { rank=same; b, c }
    a -> b[label="0.2",weight="0.2"];
    a -> c[label="0.4",weight="0.4",color=red,penwidth=3.0];
    c -> b[label="0.6",weight="0.6",constraint=false];
    c -> e[label="0.6",weight="0.6",color=red,penwidth=3.0];
    e -> e[label="0.1",weight="0.1"];
    e -> b[label="0.7",weight="0.7",color=red,penwidth=3.0,constraint=false];
}
{% endgraphviz %}
```

Which looks like:

{% graphviz %}
digraph {
    { rank=same; b, c }
    a -> b[label="0.2",weight="0.2"];
    a -> c[label="0.4",weight="0.4",color=red,penwidth=3.0];
    c -> b[label="0.6",weight="0.6",constraint=false];
    c -> e[label="0.6",weight="0.6",color=red,penwidth=3.0];
    e -> e[label="0.1",weight="0.1"];
    e -> b[label="0.7",weight="0.7",color=red,penwidth=3.0,constraint=false];
}
{% endgraphviz %}

### Controlling the `<div>`'s `id`

The `<div class="graphviz">` tag includes an `id` attribute determined by, in order:

{% raw %}
1. A parameter passed to the Liquid tag (e.g. `{% graphviz Id %}`)
2. The name of the graph (e.g. `graph Id { â€¦ }`)
3. A hash of the graph's source code
{% endraw %}

[^package]: Provided on most platforms by a `graphviz` package
[^gem]: Though this seems like the perfect opportunity for me to learn someday
